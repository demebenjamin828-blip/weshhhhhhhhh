<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Examen Nouveau Testament üìñ</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<style>
:root { --success:#2ecc71; --error:#e74c3c; --primary:#27ae60; --soft:#eafaf1; --gold:#f1c40f; }
body { font-family:'Segoe UI', sans-serif; background: linear-gradient(135deg,#f3fbf6,#d4efdf); display:flex; justify-content:center; align-items:center; min-height:100vh; margin:0; }
.quiz-card { background:white; padding:30px; border-radius:20px; box-shadow:0 20px 50px rgba(0,0,0,0.15); width:90%; max-width:600px; position:relative; }
.step { display:none; }
.step.active { display:block; animation: fadeIn 0.5s ease; }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
.q-block { margin-bottom:15px; padding:15px; border-radius:12px; border:1px solid #d4efdf; background:#fff; }
input { width:100%; padding:12px; border:2px solid #e2e8f0; border-radius:10px; box-sizing:border-box; font-size:16px; margin-top:5px; }
.btn-nav { width:100%; padding:16px; background:var(--primary); color:white; border:none; border-radius:12px; cursor:pointer; font-weight:bold; margin-top:10px; }
#timer { font-weight: bold; font-size: 18px; text-align: center; margin: 10px 0; color: var(--primary); background: var(--soft); padding: 10px; border-radius: 8px; display: none; }
.timer-danger { color: var(--error) !important; }
.progress-container { width:100%; background:#d4efdf; border-radius:12px; height:10px; margin-bottom:10px; }
.progress-bar { height:100%; width:0%; background:var(--primary); border-radius:12px; transition: 0.5s; }
.score-anim { font-size: 50px; color: var(--success); text-align: center; font-weight: bold; }
.grade-badge { display: inline-block; padding: 8px 15px; background: var(--gold); color: white; border-radius: 20px; margin-top: 10px; }
.tableau-result { width:100%; border-collapse: collapse; margin-top:20px; }
.tableau-result th, .tableau-result td { border:1px solid #ddd; padding:10px; text-align:left; }
.commentaires { margin-top:20px; padding:15px; background:#f9fbfd; border-left:4px solid var(--primary); border-radius:8px; font-size: 14px; }
</style>
</head>
<body>

<audio id="beepSound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>
<audio id="finishSound" src="https://assets.mixkit.co/active_storage/sfx/2866/2866-preview.mp3"></audio>

<div class="quiz-card">
  <h2 style="text-align:center; color:var(--primary);">Examen Biblique üïäÔ∏è</h2>
  <div class="progress-container"><div class="progress-bar" id="progressBar"></div></div>
  <div id="timer">‚è±Ô∏è Temps : 02:00</div>

  <form id="quizForm">
    <div class="step active" id="step0">
      <div class="q-block">
        <label>Pr√©nom</label><input type="text" id="prenom" required>
        <label>Nom</label><input type="text" id="nom" required>
        <label>Email</label><input type="email" id="email" required>
      </div>
      <button type="button" class="btn-nav" onclick="startQuiz()">Commencer üöÄ</button>
    </div>

    <div class="step" id="step1">
      <div class="q-block"><label>1. Ville de naissance de J√©sus ?</label><input id="q1"></div>
      <div class="q-block"><label>2. Qui a reni√© J√©sus ?</label><input id="q2"></div>
      <button type="button" class="btn-nav" onclick="nextStep(1)">Suivant ‚Üí</button>
    </div>

    <div class="step" id="step2">
      <div class="q-block"><label>3. Dernier livre de la Bible ?</label><input id="q3"></div>
      <div class="q-block"><label>4. Qui a baptis√© J√©sus ?</label><input id="q4"></div>
      <button type="button" class="btn-nav" onclick="nextStep(2)">Suivant ‚Üí</button>
    </div>

    <div class="step" id="step3">
      <div class="q-block"><label>5. Nombre d'√âvangiles ?</label><input id="q5"></div>
      <div class="q-block"><label>6. Mer o√π J√©sus a march√© ?</label><input id="q6"></div>
      <button type="button" class="btn-nav" onclick="nextStep(3)">Suivant ‚Üí</button>
    </div>

    <div class="step" id="step4">
      <div class="q-block"><label>7. Auteur principal des √âp√Ætres ?</label><input id="q7"></div>
      <div class="q-block"><label>8. Miracle de Cana ?</label><input id="q8"></div>
      <button type="button" class="btn-nav" onclick="nextStep(4)">Derni√®re √©tape ‚Üí</button>
    </div>

    <div class="step" id="step5">
      <div class="q-block"><label>9. Ap√¥tre collecteur d'imp√¥ts ?</label><input id="q9"></div>
      <div class="q-block"><label>10. Qui a trahi J√©sus ?</label><input id="q10"></div>
      <button type="submit" class="btn-nav" style="background:var(--success);">Valider ‚úÖ</button>
    </div>
  </form>

  <div id="finalSection" style="display:none; text-align:center;">
    <div id="res-summary"></div>
    <div id="recap-table"></div>
    <button onclick="location.reload()" class="btn-nav" style="background:#7f8c8d;">Recommencer</button>
  </div>
</div>

<script>
// CONFIGURATION SUPABASE AVEC TES INFOS
const _supabase = supabase.createClient('https://inrcrtyvbgjrrccpzxlk.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlucmNydHl2YmdqcnJjY3B6eGxrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5NjkxOTIsImV4cCI6MjA4NzU0NTE5Mn0.9Fg6ixbWUS4twFBVZmeSKYYMB9JJHIQb8LoMYe0g9js');
emailjs.init("ulU_NSZFdTj6ZZV8T");

const ANSWERS = {
  q1:{opt:["bethleem","bethleem"], desc:"J√©sus est n√© √† Bethl√©em."},
  q2:{opt:["pierre"], desc:"Pierre a reni√© J√©sus."},
  q3:{opt:["apocalypse"], desc:"Dernier livre de la Bible."},
  q4:{opt:["jean baptiste","jean-baptiste"], desc:"Jean-Baptiste a baptis√© J√©sus."},
  q5:{opt:["4","quatre"], desc:"Il y a quatre √©vangiles."},
  q6:{opt:["galilee","galilee"], desc:"Mer de Galil√©e."},
  q7:{opt:["paul"], desc:"Paul a √©crit les √©p√Ætres."},
  q8:{opt:["vin","eau en vin"], desc:"Changement de l'eau en vin."},
  q9:{opt:["matthieu"], desc:"Matthieu √©tait publicain."},
  q10:{opt:["judas"], desc:"Judas a trahi J√©sus."}
};

let timeLeft = 120;
let timerInterval;
let currentStep = 0;

function startQuiz() {
  if(!document.getElementById('prenom').value) return alert("Remplis tes infos !");
  document.getElementById('timer').style.display = 'block';
  nextStep(0);
}

function resetTimer() {
  clearInterval(timerInterval);
  timeLeft = 120;
  updateTimerUI();
  timerInterval = setInterval(() => {
    timeLeft--;
    updateTimerUI();
    if(timeLeft <= 10 && timeLeft > 0) document.getElementById('beepSound').play().catch(()=>{});
    if(timeLeft <= 0) {
      if(currentStep < 5) nextStep(currentStep);
      else document.getElementById('quizForm').requestSubmit();
    }
  }, 1000);
}

function updateTimerUI() {
  const m = Math.floor(timeLeft/60); const s = timeLeft%60;
  const d = document.getElementById('timer');
  d.innerText = `‚è±Ô∏è Temps √©tape : ${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
  if(timeLeft <= 10) d.classList.add('timer-danger'); else d.classList.remove('timer-danger');
}

function nextStep(n) {
  currentStep = n + 1;
  document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
  document.getElementById('step' + currentStep).classList.add('active');
  document.getElementById('progressBar').style.width = (currentStep/5*100) + "%";
  if(currentStep <= 5) resetTimer();
}

function normalize(t){ return t.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").trim(); }

document.getElementById('quizForm').addEventListener('submit', async e => {
  e.preventDefault();
  clearInterval(timerInterval);
  
  let score = 0;
  let tableauHTML = "";
  let commentairesHTML = "<hr><h3>Explications</h3>";

  for(let i=1; i<=10; i++) {
    const val = document.getElementById('q'+i).value.trim();
    const config = ANSWERS['q'+i];
    const isCorrect = config.opt.map(a => normalize(a)).includes(normalize(val));
    if(isCorrect) score++;
    
    tableauHTML += `<tr><td>Q${i}</td><td>${val || "-"}</td><td>${isCorrect?'‚úÖ':'‚ùå'}</td></tr>`;
    commentairesHTML += `<div style="margin-bottom:10px; text-align:left;"><b>Q${i}:</b> ${config.desc}</div>`;
  }

  const p = document.getElementById('prenom').value;
  const n = document.getElementById('nom').value;
  const em = document.getElementById('email').value;

  // ENVOI SUPABASE
  try {
    await _supabase.from('reponses').upsert({ email: em, prenom: p, nom: n, score: score });
  } catch (err) { console.error(err); }

  // ENVOI EMAILJS
  emailjs.send('service_raxr77e','template_244yyoi',{ prenom:p, score:score, tableau_html:tableauHTML });

  // AFFICHAGE FINAL
  document.getElementById('quizForm').style.display = 'none';
  document.getElementById('timer').style.display = 'none';
  document.getElementById('finalSection').style.display = 'block';
  
  if(score >= 7) confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });

  document.getElementById('res-summary').innerHTML = `
    <div class="score-anim">${score}/10</div>
    <div class="grade-badge">${score >= 8 ? "üìñ Disciple Fid√®le" : "üå± Jeune Pousse"}</div>
    <p>Bravo ${p} ! Tes r√©sultats sont enregistr√©s.</p>
  `;
  document.getElementById('recap-table').innerHTML = `
    <table class="tableau-result"><thead><tr><th>Q¬∞</th><th>R√©ponse</th><th>Etat</th></tr></thead><tbody>${tableauHTML}</tbody></table>
    <div class="commentaires">${commentairesHTML}</div>
  `;
});
</script>
</body>
</html>
