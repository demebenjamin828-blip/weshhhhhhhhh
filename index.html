<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Examen Nouveau Testament üìñ</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<style>
:root { --success:#2ecc71; --error:#e74c3c; --primary:#27ae60; --soft:#eafaf1; --gold:#f1c40f; }
body { font-family:'Segoe UI', sans-serif; background:#f3fbf6; display:flex; justify-content:center; align-items:center; min-height:100vh; margin:0; }
.quiz-card { background:white; padding:30px; border-radius:20px; box-shadow:0 15px 35px rgba(0,0,0,0.1); width:90%; max-width:550px; text-align:center; }
.step { display:none; }
.step.active { display:block; }
.q-block { margin-bottom:15px; padding:15px; border:1px solid #d4efdf; border-radius:12px; text-align:left; }
input { width:100%; padding:12px; border:2px solid #e2e8f0; border-radius:10px; box-sizing:border-box; font-size:16px; margin-top:5px; }
.btn-nav { width:100%; padding:16px; background:var(--primary); color:white; border:none; border-radius:12px; cursor:pointer; font-weight:bold; margin-top:10px; }
#timer { font-weight:bold; margin:10px 0; color:var(--primary); background:var(--soft); padding:8px; border-radius:8px; }
.progress-container { width:100%; background:#d4efdf; border-radius:10px; height:8px; margin-bottom:15px; }
.progress-bar { height:100%; width:0%; background:var(--primary); border-radius:10px; transition:0.5s; }
#loading { display:none; color: var(--primary); font-weight: bold; margin: 20px 0; }
.tableau-result { width:100%; border-collapse: collapse; margin-top:20px; font-size:14px; }
.tableau-result td, .tableau-result th { border:1px solid #ddd; padding:8px; }
</style>
</head>
<body>

<div class="quiz-card">
  <h2 style="color:var(--primary);">Examen Biblique üïäÔ∏è</h2>
  <div class="progress-container"><div class="progress-bar" id="progressBar"></div></div>
  <div id="timer" style="display:none;">‚è±Ô∏è 02:00</div>
  
  <div id="loading">Envoi des r√©sultats en cours... ‚è≥</div>

  <form id="quizForm">
    <div class="step active" id="step0">
      <div class="q-block">
        <label>Pr√©nom</label><input type="text" id="prenom" required>
        <label>Nom</label><input type="text" id="nom" required>
        <label>Email</label><input type="email" id="email" required>
      </div>
      <button type="button" class="btn-nav" onclick="startQuiz()">Commencer üöÄ</button>
    </div>

    <div class="step" id="step1">
      <div class="q-block"><label>1. Ville de naissance de J√©sus ?</label><input id="q1"></div>
      <div class="q-block"><label>2. Qui a reni√© J√©sus ?</label><input id="q2"></div>
      <button type="button" class="btn-nav" onclick="nextStep(1)">Suivant ‚Üí</button>
    </div>
    <div class="step" id="step2">
      <div class="q-block"><label>3. Dernier livre de la Bible ?</label><input id="q3"></div>
      <div class="q-block"><label>4. Qui a baptis√© J√©sus ?</label><input id="q4"></div>
      <button type="button" class="btn-nav" onclick="nextStep(2)">Suivant ‚Üí</button>
    </div>
    <div class="step" id="step3">
      <div class="q-block"><label>5. Nombre d'√âvangiles ?</label><input id="q5"></div>
      <div class="q-block"><label>6. Mer o√π J√©sus a march√© ?</label><input id="q6"></div>
      <button type="button" class="btn-nav" onclick="nextStep(3)">Suivant ‚Üí</button>
    </div>
    <div class="step" id="step4">
      <div class="q-block"><label>7. Auteur principal des √âp√Ætres ?</label><input id="q7"></div>
      <div class="q-block"><label>8. Miracle de Cana ?</label><input id="q8"></div>
      <button type="button" class="btn-nav" onclick="nextStep(4)">Suivant ‚Üí</button>
    </div>
    <div class="step" id="step5">
      <div class="q-block"><label>9. Ap√¥tre collecteur d'imp√¥ts ?</label><input id="q9"></div>
      <div class="q-block"><label>10. Qui a trahi J√©sus ?</label><input id="q10"></div>
      <button type="submit" class="btn-nav" style="background:var(--success);">Valider l'examen ‚úÖ</button>
    </div>
  </form>

  <div id="finalSection" style="display:none;">
    <h1 id="finalScore" style="font-size:50px; color:var(--success); margin:10px 0;">0/10</h1>
    <p id="finalMsg"></p>
    <div id="recap-table"></div>
    <button onclick="location.reload()" class="btn-nav" style="background:#7f8c8d;">Recommencer</button>
  </div>
</div>

<script>
const _supabase = supabase.createClient('https://inrcrtyvbgjrrccpzxlk.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlucmNydHl2YmdqcnJjY3B6eGxrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5NjkxOTIsImV4cCI6MjA4NzU0NTE5Mn0.9Fg6ixbWUS4twFBVZmeSKYYMB9JJHIQb8LoMYe0g9js');
emailjs.init("ulU_NSZFdTj6ZZV8T");

const ANSWERS = {
  q1:["bethleem","bethl√©em"], q2:["pierre"], q3:["apocalypse"], q4:["jean baptiste","jean-baptiste"],
  q5:["4","quatre"], q6:["galilee","galil√©e"], q7:["paul"], q8:["vin","eau en vin"], q9:["matthieu"], q10:["judas"]
};

let timeLeft = 120; let timerInterval; let currentStep = 0;

function startQuiz() {
  if(!document.getElementById('prenom').value) return alert("Pr√©nom requis");
  document.getElementById('timer').style.display = 'block';
  nextStep(0);
}

function nextStep(n) {
  currentStep = n + 1;
  document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
  document.getElementById('step' + currentStep).classList.add('active');
  document.getElementById('progressBar').style.width = (currentStep/5*100) + "%";
  if(currentStep <= 5) {
    clearInterval(timerInterval); timeLeft = 120;
    timerInterval = setInterval(() => {
      timeLeft--;
      let m = Math.floor(timeLeft/60), s = timeLeft%60;
      document.getElementById('timer').innerText = `‚è±Ô∏è ${m}:${s<10?'0':''}${s}`;
      if(timeLeft <= 0) { if(currentStep < 5) nextStep(currentStep); else document.getElementById('quizForm').requestSubmit(); }
    }, 1000);
  }
}

document.getElementById('quizForm').addEventListener('submit', async e => {
  e.preventDefault();
  clearInterval(timerInterval);
  document.getElementById('quizForm').style.display = 'none';
  document.getElementById('timer').style.display = 'none';
  document.getElementById('loading').style.display = 'block';

  let score = 0; let table = "";
  for(let i=1; i<=10; i++) {
    let val = document.getElementById('q'+i).value.trim().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
    let isOk = ANSWERS['q'+i].includes(val);
    if(isOk) score++;
    table += `<tr><td>Q${i}</td><td>${val||"-"}</td><td>${isOk?'‚úÖ':'‚ùå'}</td></tr>`;
  }

  const p = document.getElementById('prenom').value, n = document.getElementById('nom').value, em = document.getElementById('email').value;

  // AFFICHAGE IMMEDIAT (Pas d'attente pour Supabase)
  document.getElementById('loading').style.display = 'none';
  document.getElementById('finalSection').style.display = 'block';
  document.getElementById('finalScore').innerText = score + "/10";
  document.getElementById('finalMsg').innerText = "Bravo " + p + " !";
  document.getElementById('recap-table').innerHTML = `<table class="tableau-result"><tr><th>Q¬∞</th><th>R√©ponse</th><th>Resultat</th></tr>${table}</table>`;
  if(score >= 7) confetti();

  // ENVOI EN ARRIERE PLAN
  try {
     _supabase.from('reponses').upsert({ email: em, prenom: p, nom: n, score: score }).then(() => console.log("DB OK"));
     emailjs.send('service_raxr77e','template_244yyoi',{ prenom:p, score:score, tableau_html:table }).then(() => console.log("Email OK"));
  } catch(e) { console.log("Erreur envoi mais affichage fait"); }
});
</script>
</body>
</html>
