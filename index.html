<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Examen Nouveau Testament üìñ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <style>
        :root { --success:#27ae60; --error:#e74c3c; --primary:#2c3e50; }
        body { font-family:'Segoe UI',sans-serif; background:#f0f2f5; display:flex; justify-content:center; padding:20px; margin:0; }
        .quiz-card { background:white; padding:30px; border-radius:15px; box-shadow:0 10px 30px rgba(0,0,0,0.1); width:100%; max-width:600px; animation: fadeInPower 0.9s cubic-bezier(0.22, 1, 0.36, 1); }
        @keyframes fadeInPower { 0% {opacity:0; transform:translateY(40px);} 100% {opacity:1; transform:translateY(0);} }
        .step { display:none; }
        .step.active { display:block; }
        .q-block { margin-bottom:15px; padding:15px; border-radius:10px; border:1px solid #eee; }
        input { width:100%; padding:12px; border:2px solid #ddd; border-radius:8px; box-sizing:border-box; }
        .btn-nav { width:100%; padding:15px; background:var(--primary); color:white; border:none; border-radius:8px; cursor:pointer; font-weight:bold; margin-top:10px; }
        .feedback { display:none; font-size:14px; margin-top:10px; font-weight:bold; }
        .is-correct { border-color:var(--success)!important; background:#f0fff4; }
        .is-wrong { border-color:var(--error)!important; background:#fff5f5; }
        table { width:100%; border-collapse:collapse; margin-top:15px; font-size:14px; }
        th, td { padding:10px; border:1px solid #ddd; text-align:left; }
    </style>
</head>
<body>

<div class="quiz-card">
    <h2 style="text-align:center;">Quiz Biblique üïäÔ∏è</h2>
    <form id="quizForm">
        <div class="step active" id="step0">
            <div class="q-block">
                <label>Pr√©nom</label><input type="text" id="prenom" required><br><br>
                <label>Nom</label><input type="text" id="nom" required><br><br>
                <label>Email</label><input type="email" id="email" required>
            </div>
            <button type="button" class="btn-nav" onclick="nextStep(0)">Commencer l'examen</button>
        </div>

        <div class="step" id="step1">
            <div class="q-block" id="block1"><label>1. Ville de naissance de J√©sus ?</label><input id="q1"><div class="feedback" id="f1"></div></div>
            <div class="q-block" id="block2"><label>2. Qui a reni√© J√©sus ?</label><input id="q2"><div class="feedback" id="f2"></div></div>
            <button type="button" class="btn-nav" onclick="nextStep(1)">Suivant</button>
        </div>
        <div class="step" id="step2">
            <div class="q-block" id="block3"><label>3. Dernier livre de la Bible ?</label><input id="q3"><div class="feedback" id="f3"></div></div>
            <div class="q-block" id="block4"><label>4. Qui a baptis√© J√©sus ?</label><input id="q4"><div class="feedback" id="f4"></div></div>
            <button type="button" class="btn-nav" onclick="nextStep(2)">Suivant</button>
        </div>
        <div class="step" id="step3">
            <div class="q-block" id="block5"><label>5. Nombre d'√âvangiles ?</label><input id="q5"><div class="feedback" id="f5"></div></div>
            <div class="q-block" id="block6"><label>6. Mer o√π J√©sus a march√© ?</label><input id="q6"><div class="feedback" id="f6"></div></div>
            <button type="button" class="btn-nav" onclick="nextStep(3)">Suivant</button>
        </div>
        <div class="step" id="step4">
            <div class="q-block" id="block7"><label>7. Auteur principal des √âp√Ætres ?</label><input id="q7"><div class="feedback" id="f7"></div></div>
            <div class="q-block" id="block8"><label>8. Miracle de Cana ?</label><input id="q8"><div class="feedback" id="f8"></div></div>
            <button type="button" class="btn-nav" onclick="nextStep(4)">Suivant</button>
        </div>
        <div class="step" id="step5">
            <div class="q-block" id="block9"><label>9. Ap√¥tre collecteur d'imp√¥ts ?</label><input id="q9"><div class="feedback" id="f9"></div></div>
            <div class="q-block" id="block10"><label>10. Qui a trahi J√©sus ?</label><input id="q10"><div class="feedback" id="f10"></div></div>
            <button type="submit" class="btn-nav" style="background:var(--success);">Valider l'examen ‚úÖ</button>
        </div>
    </form>
    <div id="res-summary"></div>
    <button onclick="location.reload()" id="btnReset" class="btn-nav" style="display:none; background:#7f8c8d;">Recommencer</button>
</div>

<script>
    const _supabase = supabase.createClient('https://inrcrtyvbgjrrccpzxlk.supabase.co', 'sb_publishable_tEVOnHljw_fz5UC_cEG9pA_9xglC1VK');
    emailjs.init("ulU_NSZFdTj6ZZV8T");

    const ANSWERS = {
        q1: { opt: ["bethl√©em", "bethleem"], ref: "Matthieu 2:1", desc: "J√©sus est n√© √† Bethl√©em en Jud√©e, accomplissant la proph√©tie de Mich√©e." },
        q2: { opt: ["pierre"], ref: "Matthieu 26:75", desc: "Pierre a reni√© J√©sus trois fois avant que le coq ne chante." },
        q3: { opt: ["apocalypse"], ref: "Apocalypse 22:21", desc: "C'est le dernier livre de la Bible, √©crit par l'ap√¥tre Jean." },
        q4: { opt: ["jean baptiste"], ref: "Matthieu 3:13", desc: "Jean-Baptiste a baptis√© J√©sus dans les eaux du Jourdain." },
        q5: { opt: ["4"], ref: "Matthieu, Marc, Luc, Jean", desc: "Il y a quatre √©vangiles qui racontent la vie de J√©sus." },
        q6: { opt: ["galil√©e", "galilee"], ref: "Jean 6:19", desc: "J√©sus a march√© sur les eaux de la mer de Galil√©e." },
        q7: { opt: ["paul"], ref: "Actes et √âp√Ætres", desc: "Paul a √©crit la majorit√© des √©p√Ætres du Nouveau Testament." },
        q8: { opt: ["vin", "eau en vin"], ref: "Jean 2:1-11", desc: "Le premier miracle fut le changement de l'eau en vin √† Cana." },
        q9: { opt: ["matthieu"], ref: "Matthieu 9:9", desc: "Matthieu travaillait au bureau des imp√¥ts quand J√©sus l'a appel√©." },
        q10: { opt: ["judas"], ref: "Luc 22:47-48", desc: "Judas a livr√© J√©sus par un baiser pour de l'argent." }
    };

    function normalizeText(t){ return t.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").trim(); }
    function nextStep(n){ document.getElementById('step'+n).classList.remove('active'); document.getElementById('step'+(n+1)).classList.add('active'); window.scrollTo(0,0); }

    document.getElementById('quizForm').addEventListener('submit', async e => {
        e.preventDefault();
        let score = 0;
        let tableauEmailHTML = "";
        let commentairesHTML = "<hr><h3 style='color:#2c3e50;'>D√©tails et Explications Bibliques :</h3>";
        
        for(let i=1; i<=10; i++){
            const val = document.getElementById('q'+i).value.trim() || "-";
            const config = ANSWERS['q'+i];
            const isCorrect = config.opt.map(a=>normalizeText(a)).includes(normalizeText(val));
            const feedback = document.getElementById('f'+i);
            feedback.style.display = "block";

            if(isCorrect){
                score++;
                document.getElementById('block'+i).classList.add('is-correct');
                feedback.innerHTML = `‚úÖ ${config.ref}`;
            } else {
                document.getElementById('block'+i).classList.add('is-wrong');
                feedback.innerHTML = `‚ùå R√©p: ${config.opt[0]} (${config.ref})`;
            }

            // Ligne pour le tableau r√©sum√©
            tableauEmailHTML += `<tr><td style="padding:8px;border:1px solid #ddd;">Q${i}</td><td style="padding:8px;border:1px solid #ddd;">${val}</td><td style="padding:8px;border:1px solid #ddd;text-align:center;">${isCorrect?'‚úÖ':'‚ùå'}</td></tr>`;

            // Bloc pour les commentaires explicatifs
            commentairesHTML += `
                <div style="margin-bottom:15px; padding:10px; border-left:4px solid ${isCorrect?'#27ae60':'#e74c3c'}; background:#f9f9f9;">
                    <p style="margin:0;"><strong>Question ${i} :</strong> ${config.desc}</p>
                    <p style="margin:5px 0 0 0; color:#555; font-style:italic;">üìñ Verset : ${config.ref}</p>
                </div>`;
        }

        const p = document.getElementById('prenom').value;
        const n = document.getElementById('nom').value;
        const em = document.getElementById('email').value;

        // Envoi EmailJS avec template_244yyoi
        emailjs.send('service_raxr77e', 'template_244yyoi', {
            prenom: p, nom: n, email: em, score: score, 
            tableau_html: tableauEmailHTML,
            commentaires_html: commentairesHTML
        }).then(() => alert("Email de r√©sultats envoy√© !"));

        await _supabase.from('reponses').upsert({email:em, prenom:p, nom:n, score:score}, {onConflict:'email'});
        
        document.getElementById('res-summary').innerHTML = `<h3 style="text-align:center;">Score Final : ${score}/10</h3><p style="text-align:center;">Les explications bibliques ont √©t√© envoy√©es sur votre mail.</p>`;
        document.getElementById('btnReset').style.display = "block";
    });
</script>
</body>
</html>
