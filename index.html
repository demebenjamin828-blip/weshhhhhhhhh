<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Examen Nouveau Testament üìñ</title>
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons (optionnel) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <!-- Scripts externes -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
  <style>
    /* --- STYLES PERSONNALIS√âS (conserv√©s pour les animations et couleurs sp√©cifiques) --- */
    :root {
      --success: #2ecc71;
      --error: #e74c3c;
      --primary: #27ae60;
      --primary-dark: #1e8449;
      --soft: #eafaf1;
      --text: #2c3e50;
    }

    body {
      background: linear-gradient(135deg, #f3fbf6, #d4efdf);
      min-height: 100vh;
      font-family: 'Segoe UI', sans-serif;
      color: var(--text);
    }

    /* Carte principale du quiz */
    .quiz-card {
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 50px rgba(0,0,0,0.15);
      animation: slideIn 0.8s ease;
      max-width: 700px;
      margin: 20px auto;
    }

    @keyframes slideIn {
      0% { opacity: 0; transform: translateY(30px); }
      100% { opacity: 1; transform: translateY(0); }
    }

    /* √âtapes */
    .step { display: none; }
    .step.active { display: block; animation: fadeInRight 0.5s ease; }
    @keyframes fadeInRight {
      0% { opacity: 0; transform: translateX(20px); }
      100% { opacity: 1; transform: translateX(0); }
    }

    /* Bloc question */
    .q-block {
      margin-bottom: 20px;
      padding: 20px;
      border-radius: 12px;
      border: 1px solid #d4efdf;
      background: #ffffff;
      transition: 0.3s;
    }
    .q-block:hover {
      border-color: var(--primary);
      background: var(--soft);
      transform: translateY(-2px);
    }

    /* Boutons de niveau et options QCM */
    .level-btn, .option-btn {
      display: block;
      width: 100%;
      padding: 15px;
      margin: 8px 0;
      background: #f8f9fa;
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      text-align: left;
      cursor: pointer;
      transition: 0.3s;
      font-size: 15px;
      color: var(--text);
      box-sizing: border-box;
    }
    .level-btn:hover, .option-btn:hover {
      background: var(--soft);
      border-color: var(--primary);
    }
    .level-btn.selected, .option-btn.selected {
      background: var(--primary);
      color: white;
      border-color: var(--primary-dark);
    }

    .is-correct { border-color: var(--success) !important; background: #f0fff4; }
    .is-wrong { border-color: var(--error) !important; background: #fff5f5; }

    .feedback {
      display: none;
      font-size: 14px;
      margin-top: 12px;
      font-weight: 600;
      animation: popIn 0.4s ease;
    }
    @keyframes popIn {
      0% { transform: scale(0.9); }
      100% { transform: scale(1); }
    }

    .score-anim {
      font-size: 48px;
      color: var(--success);
      text-align: center;
      animation: bounce 1s infinite alternate;
    }
    @keyframes bounce {
      from { transform: scale(1); }
      to { transform: scale(1.1); }
    }

    .timer-danger {
      color: var(--error) !important;
      animation: shake 0.5s infinite;
    }
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(5px); }
      75% { transform: translateX(-5px); }
    }

    .verse {
      margin-top: 30px;
      text-align: center;
      font-style: italic;
      color: #555;
      background: #f7f7f7;
      padding: 15px;
      border-radius: 10px;
    }

    /* Personnalisation de la page d'accueil (conserv√©e avec ajustements) */
    #premium-welcome {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #1b3d1a 0%, #27ae60 100%);
      z-index: 9999;
      display: flex;
      justify-content: center;
      align-items: center;
      transition: transform 0.8s cubic-bezier(0.77, 0, 0.175, 1);
      color: white;
      overflow: hidden;
    }

    .welcome-overlay {
      position: absolute;
      width: 100%;
      height: 100%;
      background: url('https://www.transparenttextures.com/patterns/paper-fibers.png');
      opacity: 0.2;
    }

    .welcome-content {
      text-align: center;
      z-index: 2;
      padding: 20px;
      max-width: 500px;
    }

    .bible-frame {
      width: 120px;
      height: 120px;
      background: rgba(255, 255, 255, 0.1);
      border: 2px solid #d4af37;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 0 auto 30px;
      box-shadow: 0 0 30px rgba(212, 175, 55, 0.3);
      animation: pulseGold 2s infinite;
    }

    .bible-emoji { font-size: 60px; filter: drop-shadow(0 5px 10px rgba(0,0,0,0.3)); }

    @keyframes pulseGold {
      0% { transform: scale(1); box-shadow: 0 0 20px rgba(212, 175, 55, 0.3); }
      50% { transform: scale(1.05); box-shadow: 0 0 40px rgba(212, 175, 55, 0.5); }
      100% { transform: scale(1); box-shadow: 0 0 20px rgba(212, 175, 55, 0.3); }
    }

    .hide-welcome { transform: translateY(-100%); }

    /* Ajustements responsives */
    @media (max-width: 576px) {
      .quiz-card { padding: 20px; }
      .welcome-title { font-size: 1.8rem; }
    }
  </style>
</head>
<body>

  <!-- Audio √©l√©ments -->
  <audio id="beepSound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>
  <audio id="finishSound" src="https://assets.mixkit.co/active_storage/sfx/2866/2866-preview.mp3"></audio>

  <!-- PAGE D'ACCUEIL BOOTSTRAP√âE (mais gardant le style original) -->
  <div id="premium-welcome">
    <div class="welcome-overlay"></div>
    <div class="welcome-content">
      <div class="bible-frame">
        <span class="bible-emoji">üìñ</span>
      </div>
      <h1 class="welcome-title display-4 fw-bold">Examen du Nouveau Testament</h1>
      <p class="welcome-subtitle lead">Plongez dans les √âcritures et testez vos connaissances spirituelles.</p>

      <div class="welcome-stats d-flex justify-content-around bg-dark bg-opacity-25 p-3 rounded-4 mb-4 border border-light border-opacity-10">
        <div class="stat-item text-center"><span class="fw-bold fs-4">10</span><br><small class="text-uppercase opacity-75">Questions</small></div>
        <div class="stat-item text-center"><span class="fw-bold fs-4">2</span><br><small class="text-uppercase opacity-75">Niveaux</small></div>
        <div class="stat-item text-center"><span class="fw-bold fs-4">120s</span><br><small class="text-uppercase opacity-75">Chrono</small></div>
      </div>

      <button class="welcome-cta btn btn-light btn-lg rounded-pill px-5 py-3 fw-bold shadow-lg" onclick="launchQuiz()">
        Commencer le Voyage üöÄ
      </button>
    </div>
  </div>

  <!-- CARTE PRINCIPALE DU QUIZ (avec classes Bootstrap) -->
  <div class="container py-4">
    <div class="quiz-card p-4 p-md-5">
      <h2 class="text-center mb-4" style="color: var(--primary);">Quiz Biblique üïäÔ∏è</h2>

      <!-- Barre de progression Bootstrap -->
      <div class="progress mb-3" style="height: 12px;">
        <div class="progress-bar bg-success" id="progressBar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
      </div>

      <!-- Timer -->
      <div id="timer" class="alert alert-success text-center fw-bold d-none" role="alert">
        ‚è±Ô∏è Temps restant : 02:00
      </div>

      <form id="quizForm">
        <!-- √âtape 0 : informations personnelles -->
        <div class="step active" id="step0">
          <div class="q-block">
            <div class="mb-3">
              <label for="prenom" class="form-label fw-semibold">Pr√©nom</label>
              <input type="text" class="form-control" id="prenom" required>
            </div>
            <div class="mb-3">
              <label for="nom" class="form-label fw-semibold">Nom</label>
              <input type="text" class="form-control" id="nom" required>
            </div>
            <div class="mb-3">
              <label for="email" class="form-label fw-semibold">Email</label>
              <input type="email" class="form-control" id="email" required>
            </div>
            <label class="fw-semibold mb-2">Choisissez votre niveau :</label>
            <div class="level-container d-flex gap-2 flex-column flex-sm-row">
              <button type="button" class="level-btn flex-fill" onclick="setLevel('Interm√©diaire', this)">Interm√©diaire<br>üü¢ QCM</button>
              <button type="button" class="level-btn flex-fill" onclick="setLevel('Difficile', this)">Difficile<br>üî¥ Texte</button>
            </div>
          </div>
          <button type="button" class="btn btn-success w-100 py-3 fw-bold" onclick="startQuiz()">Commencer üöÄ</button>
        </div>

        <!-- √âtape 1 -->
        <div class="step" id="step1">
          <div class="q-block" id="block1"><label class="fw-semibold">1. Ville de naissance de J√©sus ?</label><input id="q1" class="form-control mt-2"><div class="feedback" id="f1"></div></div>
          <div class="q-block" id="block2"><label class="fw-semibold">2. Qui a reni√© J√©sus ?</label><input id="q2" class="form-control mt-2"><div class="feedback" id="f2"></div></div>
          <button type="button" class="btn btn-success w-100 py-3 fw-bold" onclick="nextStep(1)">Suivant ‚Üí</button>
        </div>

        <!-- √âtape 2 -->
        <div class="step" id="step2">
          <div class="q-block" id="block3"><label class="fw-semibold">3. Dernier livre de la Bible ?</label><input id="q3" class="form-control mt-2"><div class="feedback" id="f3"></div></div>
          <div class="q-block" id="block4"><label class="fw-semibold">4. Qui a baptis√© J√©sus ?</label><input id="q4" class="form-control mt-2"><div class="feedback" id="f4"></div></div>
          <button type="button" class="btn btn-success w-100 py-3 fw-bold" onclick="nextStep(2)">Suivant ‚Üí</button>
          <button type="button" class="btn btn-secondary w-100 py-3 fw-bold mt-2" onclick="prevStep(2)">‚Üê Retour</button>
        </div>

        <!-- √âtape 3 -->
        <div class="step" id="step3">
          <div class="q-block" id="block5"><label class="fw-semibold">5. Nombre d'√âvangiles ?</label><input id="q5" class="form-control mt-2"><div class="feedback" id="f5"></div></div>
          <div class="q-block" id="block6"><label class="fw-semibold">6. Mer o√π J√©sus a march√© ?</label><input id="q6" class="form-control mt-2"><div class="feedback" id="f6"></div></div>
          <button type="button" class="btn btn-success w-100 py-3 fw-bold" onclick="nextStep(3)">Suivant ‚Üí</button>
          <button type="button" class="btn btn-secondary w-100 py-3 fw-bold mt-2" onclick="prevStep(3)">‚Üê Retour</button>
        </div>

        <!-- √âtape 4 -->
        <div class="step" id="step4">
          <div class="q-block" id="block7"><label class="fw-semibold">7. Auteur principal des √âp√Ætres ?</label><input id="q7" class="form-control mt-2"><div class="feedback" id="f7"></div></div>
          <div class="q-block" id="block8"><label class="fw-semibold">8. Miracle de Cana ?</label><input id="q8" class="form-control mt-2"><div class="feedback" id="f8"></div></div>
          <button type="button" class="btn btn-success w-100 py-3 fw-bold" onclick="nextStep(4)">Derni√®re √©tape ‚Üí</button>
          <button type="button" class="btn btn-secondary w-100 py-3 fw-bold mt-2" onclick="prevStep(4)">‚Üê Retour</button>
        </div>

        <!-- √âtape 5 -->
        <div class="step" id="step5">
          <div class="q-block" id="block9"><label class="fw-semibold">9. Ap√¥tre collecteur d'imp√¥ts ?</label><input id="q9" class="form-control mt-2"><div class="feedback" id="f9"></div></div>
          <div class="q-block" id="block10"><label class="fw-semibold">10. Qui a trahi J√©sus ?</label><input id="q10" class="form-control mt-2"><div class="feedback" id="f10"></div></div>
          <button type="submit" class="btn btn-success w-100 py-3 fw-bold" style="background:var(--success);">Valider ‚úÖ</button>
          <button type="button" class="btn btn-secondary w-100 py-3 fw-bold mt-2" onclick="prevStep(5)">‚Üê Retour</button>
        </div>
      </form>

      <!-- R√©sum√© et tableau r√©capitulatif -->
      <div id="res-summary" class="mt-4"></div>
      <div id="recap-table" style="display:none;"></div>
      <button onclick="location.reload()" id="btnReset" class="btn btn-secondary w-100 py-3 fw-bold mt-4" style="display:none;">Recommencer</button>
    </div>
  </div>

  <!-- Bootstrap JS (avec Popper) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // ==========================
    // CONFIGURATION SUPABASE ET EMAILJS
    // ==========================
    const _supabase = supabase.createClient('https://inrcrtyvbgjrrccpzxlk.supabase.co','sb_publishable_tEVOnHljw_fz5UC_cEG9pA_9xglC1VK');
    emailjs.init("ulU_NSZFdTj6ZZV8T");

    // ==========================
    // BASE DE QUESTIONS
    // ==========================
    const ANSWERS = {
      q1:{opt:["bethl√©em","bethleem"], ref:"Matthieu 2:1", desc:"J√©sus est n√© √† Bethl√©em en Jud√©e.", options: ["J√©rusalem", "Bethl√©em", "Nazareth", "Caperna√ºm"]},
      q2:{opt:["pierre"], ref:"Matthieu 26:75", desc:"Pierre a reni√© J√©sus trois fois.", options: ["Jean", "Pierre", "Judas", "Paul"]},
      q3:{opt:["apocalypse"], ref:"Apocalypse 22:21", desc:"Dernier livre de la Bible.", options: ["Gen√®se", "Actes", "Apocalypse", "Romains"]},
      q4:{opt:["jean baptiste","jean-baptiste"], ref:"Matthieu 3:13", desc:"Jean-Baptiste a baptis√© J√©sus.", options: ["Jean-Baptiste", "Pierre", "Paul", "Mo√Øse"]},
      q5:{opt:["4","quatre"], ref:"Matthieu, Marc, Luc, Jean", desc:"Il y a quatre √©vangiles.", options: ["3", "4", "5", "12"]},
      q6:{opt:["galil√©e","galilee"], ref:"Jean 6:19", desc:"J√©sus a march√© sur la mer de Galil√©e.", options: ["Morte", "Rouge", "Galil√©e", "M√©diterran√©e"]},
      q7:{opt:["paul"], ref:"Actes et √âp√Ætres", desc:"Paul a √©crit la majorit√© des √©p√Ætres.", options: ["Pierre", "Paul", "Jean", "Luc"]},
      q8:{opt:["vin","eau en vin"], ref:"Jean 2:1-11", desc:"Le premier miracle fut Cana.", options: ["Eau en vin", "Gu√©rison", "Multiplication", "Marche sur l'eau"]},
      q9:{opt:["matthieu"], ref:"Matthieu 9:9", desc:"Matthieu √©tait collecteur d'imp√¥ts.", options: ["Pierre", "Matthieu", "Judas", "Andr√©"]},
      q10:{opt:["judas"], ref:"Luc 22:47-48", desc:"Judas a trahi J√©sus pour de l'argent.", options: ["Pierre", "Judas", "Jean", "Thomas"]}
    };

    let timeLeft = 120;
    let timerInterval;
    let currentStep = 0;
    let selectedNiveau = "";

    // ==========================
    // FONCTION S√âLECTION NIVEAU
    // ==========================
    function setLevel(niveau, btn) {
      selectedNiveau = niveau;
      document.querySelectorAll('.level-btn').forEach(b => b.classList.remove('selected'));
      btn.classList.add('selected');
    }

    // ==========================
    // FONCTION D√âMARRAGE
    // ==========================
    function startQuiz() {
      const p = document.getElementById('prenom').value;
      if(!p || !selectedNiveau) return alert("Veuillez remplir votre pr√©nom et choisir un niveau !");

      if(selectedNiveau === "Interm√©diaire"){
        for(let i=1; i<=10; i++){
          const input = document.getElementById('q'+i);
          input.style.display = "none";
          const container = input.parentElement;
          let optionsHTML = "";
          ANSWERS['q'+i].options.forEach(opt => {
            optionsHTML += `<button type="button" class="option-btn" onclick="selectOption(this, ${i})">${opt}</button>`;
          });
          container.insertAdjacentHTML('beforeend', optionsHTML);
        }
      }

      document.getElementById('timer').classList.remove('d-none');
      nextStep(0);
    }

    // ==========================
    // S√âLECTION QCM
    // ==========================
    function selectOption(btn, qIndex) {
      const parent = btn.parentElement;
      parent.querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected'));
      btn.classList.add('selected');
      document.getElementById('q'+qIndex).value = btn.innerText;
    }

    // ==========================
    // CHRONOM√àTRE
    // ==========================
    function resetTimer() {
      clearInterval(timerInterval);
      timeLeft = 120;
      updateTimerDisplay();

      timerInterval = setInterval(() => {
        timeLeft--;
        updateTimerDisplay();

        if (timeLeft <= 10 && timeLeft > 0) {
          document.getElementById('beepSound').play().catch(()=>{});
        }

        if (timeLeft <= 0) {
          clearInterval(timerInterval);
          document.getElementById('finishSound').play().catch(()=>{});
          if(currentStep < 5) {
            alert("Temps √©coul√© pour ces questions !");
            nextStep(currentStep);
          } else {
            alert("Temps final √©coul√© ! Validation automatique.");
            document.getElementById('quizForm').requestSubmit();
          }
        }
      }, 1000);
    }

    function updateTimerDisplay() {
      const min = Math.floor(timeLeft / 60);
      const sec = timeLeft % 60;
      const timerElem = document.getElementById('timer');
      timerElem.innerHTML = `‚è±Ô∏è Temps restant : ${min.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}`;

      if(timeLeft <= 10) timerElem.classList.add('timer-danger');
      else timerElem.classList.remove('timer-danger');
    }

    // ==========================
    // NAVIGATION
    // ==========================
    function normalizeText(t){return t.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").trim();}

    function nextStep(n){
      document.getElementById('step'+n).classList.remove('active');
      currentStep = n + 1;
      document.getElementById('step'+currentStep).classList.add('active');
      document.getElementById('progressBar').style.width = (currentStep/5*100) + "%";
      if(currentStep <= 5) resetTimer();
    }

    function prevStep(n){
      document.getElementById('step'+n).classList.remove('active');
      currentStep = n - 1;
      document.getElementById('step'+currentStep).classList.add('active');
      document.getElementById('progressBar').style.width = (currentStep/5*100) + "%";
      resetTimer();
    }

    // ==========================
    // SOUMISSION DU FORMULAIRE
    // ==========================
    document.getElementById('quizForm').addEventListener('submit', async e=>{
      e.preventDefault();
      clearInterval(timerInterval);
      document.getElementById('timer').classList.add('d-none');

      let score=0, tableauHTML="", commentairesHTML="<hr><h2 style='color:#2c3e50;'>Explications Bibliques</h2>";

      for(let i=1;i<=10;i++){
        const val=document.getElementById('q'+i).value.trim()||"-";
        const config=ANSWERS['q'+i];
        const isCorrect=config.opt.map(a=>normalizeText(a)).includes(normalizeText(val));
        const feedback=document.getElementById('f'+i);
        feedback.style.display="block";
        if(isCorrect){
          score++;
          document.getElementById('block'+i).classList.add('is-correct');
          feedback.innerHTML=`‚úÖ ${config.ref}`;
          feedback.style.color="var(--success)";
        } else {
          document.getElementById('block'+i).classList.add('is-wrong');
          feedback.innerHTML=`‚ùå ${config.ref}`;
          feedback.style.color="var(--error)";
        }

        tableauHTML+=`<tr><td style="padding:8px;border:1px solid #ddd;">Q${i}</td><td style="padding:8px;border:1px solid #ddd;">${val}</td><td style="padding:8px;border:1px solid #ddd;text-align:center;">${isCorrect?'‚úÖ':'‚ùå'}</td></tr>`;
        commentairesHTML+=`<div style="margin-bottom:15px;padding:10px;background:#f9f9f9;border-left:4px solid ${isCorrect?'#2ecc71':'#e74c3c'};">
        <p style="margin:0;"><strong>Question ${i} :</strong> ${config.desc}</p>
        <p style="margin:5px 0 0 0;font-style:italic;color:#555;">üìñ R√©f√©rence : ${config.ref}</p>
        </div>`;
      }

      const p=document.getElementById('prenom').value;
      const n=document.getElementById('nom').value;
      const em=document.getElementById('email').value;

      // Envoi √† TOI (r√©capitulatif complet)
      emailjs.send('service_raxr77e','template_uh8xoa6',{
        prenom:p, nom:n, email:em, score:score,
        tableau_html:tableauHTML,
        commentaires_html:commentairesHTML,
        niveau: selectedNiveau
      });

      // ENVOI √Ä L'UTILISATEUR (r√©sultat simple)
      emailjs.send('service_raxr77e','template_632ld9j',{
        prenom:p, 
        email:em,
        score:score,
        tableau_html:tableauHTML,
        niveau: selectedNiveau
      });

      // ENVOI VERS SUPABASE
      await _supabase.from('reponses').upsert({
        email:em, prenom:p, nom:n, score:score, niveau: selectedNiveau,
        q1: document.getElementById('q1').value,
        q2: document.getElementById('q2').value,
        q3: document.getElementById('q3').value,
        q4: document.getElementById('q4').value,
        q5: document.getElementById('q5').value,
        q6: document.getElementById('q6').value,
        q7: document.getElementById('q7').value,
        q8: document.getElementById('q8').value,
        q9: document.getElementById('q9').value,
        q10: document.getElementById('q10').value
      },{onConflict:'email'});

      // D√©sactivation des champs
      document.querySelectorAll('#quizForm input, #quizForm button').forEach(el=>el.disabled=true);
      document.getElementById('res-summary').innerHTML=`<div style="text-align:center;"><div class="score-anim">${score}/10</div><p>Bravo ${p} ! Niveau: ${selectedNiveau}</p></div>`;
      document.getElementById('recap-table').style.display = "block";
      document.getElementById('recap-table').innerHTML=`<h3 style="color:var(--primary);text-align:center;">R√©sum√© des r√©ponses</h3>
      <table class="table table-bordered"><thead><tr><th>Q¬∞</th><th>Ta r√©ponse</th><th>R√©sultat</th></tr></thead><tbody>${tableauHTML}</tbody></table>
      <div class="commentaires p-3 bg-light border-start border-4" style="border-left-color:var(--primary);">${commentairesHTML}</div>
      <div class="verse">"Ta parole est une lampe √† mes pieds..." - Psaume 119:105</div>`;
      document.getElementById('btnReset').style.display="block";
    });

    // ==========================
    // LANCEMENT DU QUIZ (page d'accueil)
    // ==========================
    function launchQuiz() {
      document.getElementById('premium-welcome').classList.add('hide-welcome');
    }
  </script>
</body>
</html>
