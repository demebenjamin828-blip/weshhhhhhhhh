<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Examen Nouveau Testament üìñ</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

<style>
:root { --success:#27ae60; --error:#e74c3c; --primary:#2c3e50; }

body {
    font-family:'Segoe UI',sans-serif;
    background:#f0f2f5;
    display:flex;
    justify-content:center;
    padding:20px;
    margin:0;
}

.quiz-card {
    background:white;
    padding:30px;
    border-radius:15px;
    box-shadow:0 10px 30px rgba(0,0,0,0.1);
    width:100%;
    max-width:600px;
    animation: fadeInPower 0.9s cubic-bezier(0.22, 1, 0.36, 1);
}

@keyframes fadeInPower {
    0% {opacity:0; transform:translateY(40px) scale(0.95);}
    60% {opacity:1; transform:translateY(-5px) scale(1.02);}
    100% {opacity:1; transform:translateY(0) scale(1);}
}

.step { display:none; }
.step.active { display:block; }

.q-block {
    margin-bottom:15px;
    padding:15px;
    border-radius:10px;
    border:1px solid #eee;
    opacity:0;
    animation: fadeInStagger 0.6s forwards;
}

@keyframes fadeInStagger {0% {opacity:0; transform:translateY(20px);} 100% {opacity:1; transform:translateY(0);}}

.step.active .q-block:nth-child(1){animation-delay:0.1s;}
.step.active .q-block:nth-child(2){animation-delay:0.2s;}
.step.active .q-block:nth-child(3){animation-delay:0.3s;}
.step.active .q-block:nth-child(4){animation-delay:0.4s;}

input {
    width:100%;
    padding:12px;
    border:2px solid #ddd;
    border-radius:8px;
    transition: all 0.3s ease;
    box-sizing:border-box;
}
input:focus {
    border-color: var(--primary);
    box-shadow:0 4px 15px rgba(44,62,80,0.2);
    outline:none;
}

.btn-nav {
    width:100%;
    padding:15px;
    background:var(--primary);
    color:white;
    border:none;
    border-radius:8px;
    cursor:pointer;
    font-weight:bold;
    margin-top:10px;
    transition: all 0.3s ease;
}
.btn-nav:hover {
    transform:translateY(-2px);
    box-shadow:0 6px 15px rgba(0,0,0,0.15);
}

.feedback {
    display:none;
    font-size:14px;
    margin-top:10px;
    font-weight:bold;
}

.is-correct { border-color:var(--success)!important; background:#f0fff4; }
.is-wrong { border-color:var(--error)!important; background:#fff5f5; }

#res-summary { display:none; margin-top:20px; transition: all 0.6s ease; }

table { width:100%; border-collapse:collapse; margin-top:15px; font-size:14px; }
th, td { padding:10px; border:1px solid #ddd; text-align:left; }
th { background:#f8f9fa; }

#btnReset { display:none; background:#7f8c8d; margin-top:20px; }
</style>
</head>

<body>

<div class="quiz-card">
<h2 style="text-align:center;">Quiz Biblique üïäÔ∏è</h2>

<form id="quizForm">

<div class="step active" id="step0">
<div class="q-block">
<label>Pr√©nom</label><input type="text" id="prenom" required><br><br>
<label>Nom</label><input type="text" id="nom" required><br><br>
<label>Email</label><input type="email" id="email" required>
</div>
<button type="button" class="btn-nav" onclick="nextStep(0)">Commencer l'examen</button>
</div>

<div class="step" id="step1">
<div class="q-block" id="block1"><label>1. Ville de naissance de J√©sus ?</label><input id="q1"><div class="feedback" id="f1"></div></div>
<div class="q-block" id="block2"><label>2. Qui a reni√© J√©sus ?</label><input id="q2"><div class="feedback" id="f2"></div></div>
<button type="button" class="btn-nav" onclick="nextStep(1)">Suivant</button>
</div>

<div class="step" id="step2">
<div class="q-block" id="block3"><label>3. Dernier livre de la Bible ?</label><input id="q3"><div class="feedback" id="f3"></div></div>
<div class="q-block" id="block4"><label>4. Qui a baptis√© J√©sus ?</label><input id="q4"><div class="feedback" id="f4"></div></div>
<button type="button" class="btn-nav" onclick="nextStep(2)">Suivant</button>
</div>

<div class="step" id="step3">
<div class="q-block" id="block5"><label>5. Nombre d'√âvangiles ?</label><input id="q5"><div class="feedback" id="f5"></div></div>
<div class="q-block" id="block6"><label>6. Mer o√π J√©sus a march√© ?</label><input id="q6"><div class="feedback" id="f6"></div></div>
<button type="button" class="btn-nav" onclick="nextStep(3)">Suivant</button>
</div>

<div class="step" id="step4">
<div class="q-block" id="block7"><label>7. Auteur principal des √âp√Ætres ?</label><input id="q7"><div class="feedback" id="f7"></div></div>
<div class="q-block" id="block8"><label>8. Miracle de Cana ?</label><input id="q8"><div class="feedback" id="f8"></div></div>
<button type="button" class="btn-nav" onclick="nextStep(4)">Suivant</button>
</div>

<div class="step" id="step5">
<div class="q-block" id="block9"><label>9. Ap√¥tre collecteur d'imp√¥ts ?</label><input id="q9"><div class="feedback" id="f9"></div></div>
<div class="q-block" id="block10"><label>10. Qui a trahi J√©sus ?</label><input id="q10"><div class="feedback" id="f10"></div></div>
<button type="submit" class="btn-nav" style="background:var(--success);">Valider ‚úÖ</button>
</div>

</form>

<div id="res-summary"></div>
<button onclick="location.reload()" id="btnReset" class="btn-nav">Recommencer</button>
</div>

<script>
const _supabase = supabase.createClient(
    'https://inrcrtyvbgjrrccpzxlk.supabase.co',
    'sb_publishable_tEVOnHljw_fz5UC_cEG9pA_9xglC1VK'
);

emailjs.init("ulU_NSZFdTj6ZZV8T"); // ta cl√© publique EmailJS

const ANSWERS = {
q1:["bethl√©em","bethleem"], q2:["pierre"], q3:["apocalypse"], 
q4:["jean baptiste"], q5:["4"], q6:["galil√©e","galilee"], 
q7:["paul"], q8:["vin","eau en vin"], q9:["matthieu"], q10:["judas"]
};

function normalizeText(text){
    return text.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").trim();
}

function nextStep(n){
    document.getElementById('step'+n).classList.remove('active');
    document.getElementById('step'+(n+1)).classList.add('active');
    window.scrollTo({top:0, behavior:'smooth'});
}

document.getElementById('quizForm').addEventListener('submit', async e => {
    e.preventDefault();
    let score = 0;
    let tableauEmailHTML = "";
    const recap = [];

    for(let i=1;i<=10;i++){
        const userRaw = document.getElementById('q'+i).value || '-';
        const correct = ANSWERS['q'+i][0];
        const isCorrect = ANSWERS['q'+i].map(a=>normalizeText(a)).includes(normalizeText(userRaw));

        const feedback = document.getElementById('f'+i);
        feedback.style.display="block";
        if(isCorrect){
            document.getElementById('block'+i).classList.add('is-correct');
            feedback.innerHTML="‚úÖ Bonne r√©ponse";
            score++;
        } else {
            document.getElementById('block'+i).classList.add('is-wrong');
            feedback.innerHTML="‚ùå R√©ponse : "+correct;
        }

        tableauEmailHTML += `
            <tr>
                <td style="padding:5px;border:1px solid #ddd;">Q${i}</td>
                <td style="padding:5px;border:1px solid #ddd;">${userRaw}</td>
                <td style="padding:5px;border:1px solid #ddd;">${correct}</td>
                <td style="padding:5px;border:1px solid #ddd;text-align:center;">${isCorrect?'‚úÖ':'‚ùå'}</td>
            </tr>
        `;

        recap.push({q:i, user:userRaw, correct:correct, status:isCorrect});
    }

    const prenom = document.getElementById('prenom').value;
    const nom = document.getElementById('nom').value;
    const email = document.getElementById('email').value;

    // 1Ô∏è‚É£ Envoi EmailJS
    emailjs.send('service_raxr77e','template_iw4149f',{
        prenom, nom, email, score, tableau_html: tableauEmailHTML
    }).then(()=>alert("R√©sultats envoy√©s !"))
    .catch(err=>console.error("Erreur EmailJS :", err));

    // 2Ô∏è‚É£ Sauvegarde Supabase
    await _supabase.from('reponses').upsert({email, prenom, nom, score},{onConflict:'email'});

    // 3Ô∏è‚É£ Affichage r√©cap sur page
    let tableHTML = `<h3>R√©capitulatif üìã</h3><table><tr><th>Q¬∞</th><th>R√©ponse</th><th>Correct</th><th>Status</th></tr>`;
    recap.forEach(r=>{
        tableHTML += `<tr><td>${r.q}</td><td>${r.user}</td><td>${r.correct}</td><td style="text-align:center;">${r.status?'‚úÖ':'‚ùå'}</td></tr>`;
    });
    tableHTML += `</table><p style="font-size:20px;font-weight:bold;text-align:center;">Score final : ${score}/10</p>`;

    const resDiv = document.getElementById('res-summary');
    resDiv.innerHTML = tableHTML;
    resDiv.style.display="block";
    document.getElementById('btnReset').style.display="block";
    document.querySelector('button[type="submit"]').style.display="none";
    window.scrollTo({top:0,behavior:'smooth'});
});
</script>

</body>
</html>
